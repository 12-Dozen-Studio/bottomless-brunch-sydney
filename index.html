<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bottomless Brunch Finder</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }
    #map {
      height: 150px;
      width: 100%;
      transition: height 0.3s ease;
    }
    .map-expanded {
      height: 300px !important;
    }
    .filters {
      padding: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: nowrap;
      justify-content: start;
      overflow-x: auto;
      max-width: 100vw;
      -webkit-overflow-scrolling: touch;
    }
    .filter {
      flex: 1;
    }
    .filter select {
      border: none;
      border-radius: 20px;
      padding: 6px 18px 6px 10px;
      background-color: #f5f1f1;
      font-size: 13px;
      background-image: url('data:image/svg+xml;utf8,<svg fill="black" height="14" viewBox="0 0 24 24" width="14" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 8px center;
      background-size: 14px;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      box-shadow: none;
      cursor: pointer;
      min-width: 100px;
      max-width: 120px;
      text-align: left;
      width: auto;
    }
    .list {
      padding: 10px;
    }
    .card {
      background: #f8f8f8;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
      border: 1px solid #ddd;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: stretch;
      height: 100px;
    }
    .card-info {
      flex: 1;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      justify-content: flex-end;
      align-items: flex-end;
    }
    .modal-content {
      background: white;
      border-radius: 16px 16px 0 0;
      width: 100%;
      max-width: 480px;
      padding: 0;
      margin: 0 auto;
      position: relative;
      bottom: 0;
      left: 0;
      right: 0;
      transform: translateY(0);
      transition: transform 0.3s ease-in-out;
      box-sizing: border-box;
    }
    @media (max-width: 375px) {
      .modal-content {
        max-width: 100%;
        border-radius: 16px 16px 0 0;
      }
    }
    .modal-close-area {
      flex-grow: 1;
      height: calc(100% - 400px); /* adjust based on modal content height */
    }
    .modal-map {
      height: 200px;
      margin-top: 10px;
    }
    .timestamp {
      text-align: center;
      font-size: 0.8em;
      color: #666;
      padding: 10px;
    }
    .image-box {
      width: auto;
      height: 100%;
      aspect-ratio: 4 / 3;
      border-radius: 6px;
      background-color: #ddd;
      background-size: cover;
      background-position: center;
      margin-left: 10px;
      flex-shrink: 0;
    }
    .modal-header {
      padding: 20px;
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
      background: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header .title {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0;
    }
    .modal-header .suburb {
      font-size: 1rem;
      color: #666;
      margin-top: 4px;
    }
    .modal-close-button {
      background: none;
      border: none;
      cursor: pointer;
      color: #444;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-stats {
      display: flex;
      justify-content: space-around;
      padding: 16px 20px;
      background: white;
      border-top: 1px solid #eee;
    }
    .modal-stat {
      text-align: center;
    }
    .modal-stat .value {
      font-weight: bold;
      font-size: 1.2rem;
    }
    .modal-stat .label {
      font-size: 0.875rem;
      color: #888;
      margin-top: 2px;
    }
    .modal-section {
      background: white;
      padding: 16px 20px;
      border-top: 1px solid #eee;
    }
    .modal-section h3 {
      font-weight: bold;
      margin: 0 0 12px 0;
    }
    .day-pill {
      background-color: #eee;
      border-radius: 16px;
      padding: 0 12px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .day {
      background-color: transparent;
      border-radius: 8px;
      font-size: 0.8rem;
      min-width: 20px;
      height: 16px;
      line-height: 16px;
      text-align: center;
      padding: 0;
    }
    .day.inactive {
      opacity: 0.3;
    }
  </style>
</head>
<body>
  <div class="timestamp">
    Page last updated: <span id="lastModified"></span>
  </div>
  <div class="filters">
    <div class="filter">
      <select id="areaFilter">
        <option value="all">Suburb</option>
      </select>
    </div>
    <div class="filter">
      <select id="priceFilter">
        <option value="all">Price</option>
        <option value="low">$0–$89</option>
        <option value="medium">$90–$109</option>
        <option value="high">$110+</option>
      </select>
    </div>
    <div class="filter">
      <select id="cuisineFilter">
        <option value="all">Cuisine</option>
      </select>
    </div>
  </div>

  <div id="map"></div>
  <div class="list" id="venueList"></div>

  <div class="modal" id="modal" onclick="hideModal(event)">
    <div class="modal-close-area"></div>
    <div class="modal-content" id="modalContent">
    </div>
    <div id="modalMap" class="modal-map"></div>
  </div>

  

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let map;
    let markers = [];
    let venues = [];
    let modalMap;

    async function init() {
      const res = await fetch("brunch_sample_10.json");
      venues = await res.json();

      map = L.map("map").setView([-33.87, 151.21], 12);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

      // Map expand/collapse functionality
      const mapContainer = document.getElementById("map");
      mapContainer.addEventListener("click", () => {
        mapContainer.classList.toggle("map-expanded");
        map.invalidateSize();
      });

      window.addEventListener("scroll", () => {
        if (window.scrollY > 100 && mapContainer.classList.contains("map-expanded")) {
          mapContainer.classList.remove("map-expanded");
          map.invalidateSize();
        }
      });

      populateAreaFilter();
      populateCuisineFilter();
      render();

      document.getElementById("areaFilter").addEventListener("change", render);
      document.getElementById("priceFilter").addEventListener("change", render);
      document.getElementById("cuisineFilter").addEventListener("change", render);

      const lastModified = new Date(document.lastModified);
      document.getElementById("lastModified").textContent = formatDateTime(lastModified);
    }

    function populateAreaFilter() {
      const areaSelect = document.getElementById("areaFilter");
      const areas = [...new Set(venues.map(v => v.suburb))];
      areaSelect.innerHTML = '<option value="all">Suburb</option>' + areas.map(area => `<option value="${area}">${area}</option>`).join('');
    }

    function populateCuisineFilter() {
      const cuisineSelect = document.getElementById("cuisineFilter");
      const cuisines = [...new Set(venues.map(v => v.cuisine).filter(Boolean))];
      cuisineSelect.innerHTML = '<option value="all">Cuisine</option>' + cuisines.map(c => `<option value="${c}">${c}</option>`).join('');
    }

    function render() {
      const day = document.getElementById("dayFilter") ? document.getElementById("dayFilter").value : "all";
      const area = document.getElementById("areaFilter").value;
      const price = document.getElementById("priceFilter").value;
      const cuisine = document.getElementById("cuisineFilter").value;

      const filtered = venues.filter(v => {
        const matchDay = true;
        const matchArea = area === "all" || v.suburb === area;
        const matchCuisine = cuisine === "all" || v.cuisine === cuisine;
        const matchPrice = price === "all" ||
          (price === "low" && v.price < 90) ||
          (price === "medium" && v.price >= 90 && v.price <= 109) ||
          (price === "high" && v.price > 109);
        return matchDay && matchArea && matchCuisine && matchPrice;
      });

      markers.forEach(m => m.remove());
      markers = [];

      const list = document.getElementById("venueList");
      list.innerHTML = "";

      filtered.forEach(v => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <div class="card-info">
            <strong>${v.name}</strong><br>
            ${v.suburb} | $${v.price}<br>
            ${v.days?.join(", ") || ""}<br>
            ${v.cuisine || ""}
          </div>
          <div class="image-box" style="background-image: url('${v.image || ""}');"></div>
        `;
        div.onclick = () => showModal(v);
        list.appendChild(div);

        const lat = v.lat !== undefined ? v.lat : (-33.87 + Math.random() * 0.05);
        const lng = v.lng !== undefined ? v.lng : (151.21 + Math.random() * 0.05);
        const marker = L.marker([lat, lng]).addTo(map)
          .on('click', () => showModal(v));
        markers.push(marker);
      });
    }

    function showModal(v) {
      const modal = document.getElementById("modal");
      const content = document.getElementById("modalContent");

      function renderDayCircles(days) {
        // Use full three-letter abbreviations for matching and display
        const dayAbbrs = days ? days.map(d => {
          if (typeof d === "string") {
            let dayLower = d.toLowerCase();
            if (dayLower.startsWith("mon")) return "Mon";
            if (dayLower.startsWith("tue")) return "Tue";
            if (dayLower.startsWith("wed")) return "Wed";
            if (dayLower.startsWith("thu")) return "Thu";
            if (dayLower.startsWith("fri")) return "Fri";
            if (dayLower.startsWith("sat")) return "Sat";
            if (dayLower.startsWith("sun")) return "Sun";
          }
          return "";
        }) : [];

        const fullDays = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
        const dayLetters = ["M", "T", "W", "T", "F", "S", "S"];

        let html = '<div style="display: flex; align-items: flex-start;"><div class="day-pill">';
        fullDays.forEach((day, i) => {
          const isAvailable = dayAbbrs.includes(day);
          html += `<span class="day${isAvailable ? '' : ' inactive'}" title="${day}">${dayLetters[i]}</span>`;
        });
        html += '</div></div>';
        return html;
      }

      content.innerHTML = `
  <div class="modal-header">
    <div>
      <h2 class="title">${v.name}</h2>
      <p class="suburb">${v.suburb}</p>
    </div>
    <button class="modal-close-button" onclick="hideModal(event)">
      <span class="material-icons">close</span>
    </button>
  </div>
  <div class="modal-stats">
    <div class="modal-stat">
      <div class="value">$${v.price}</div>
      <div class="label">per person</div>
    </div>
    <div class="modal-stat">
      <div class="value">${v.duration}min</div>
      <div class="label">session</div>
    </div>
    <div class="modal-stat">
      <div class="value">${v.cuisine || ''}</div>
      <div class="label">cuisine</div>
    </div>
  </div>
  <div class="modal-section">
    <h3>Availability</h3>
    <div style="display: flex; gap: 16px; align-items: flex-start;">
      <div style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
        <div style="font-size: 1rem; color: #666; font-weight: normal; margin-bottom: 4px;">Days</div>
        ${renderDayCircles(v.days)}
      </div>
      <div style="flex: 1; text-align: right; display: flex; flex-direction: column; align-items: center; justify-content: center;">
        <div style="font-size: 1rem; color: #666; margin-bottom: 8px;">Session Times</div>
        <div style="display: flex; flex-direction: column; gap: 6px;">
          ${Array.isArray(v.sessions) ? v.sessions.map(time =>
            `<div style="background-color: #eee; border-radius: 16px; padding: 0 16px; font-size: 0.9rem; height: 32px; display: flex; align-items: center; justify-content: center; min-width: 90px;">${time}</div>`
          ).join('') : ''}
        </div>
      </div>
    </div>
  </div>
  <div class="modal-section">
    <h3>Details</h3>
    <p class="modal-description">${v.description || ''}</p>
  </div>
`;

      if (modalMap) {
        modalMap.remove();
      }
      const lat = v.lat !== undefined ? v.lat : (-33.87 + Math.random() * 0.05);
      const lng = v.lng !== undefined ? v.lng : (151.21 + Math.random() * 0.05);
      modalMap = L.map("modalMap").setView([lat, lng], 14);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(modalMap);
      L.marker([lat, lng]).addTo(modalMap);

      modal.style.display = "flex";
    }

    function hideModal(event) {
      if (!event || event.target.classList.contains("modal") || event.target.classList.contains("modal-close-area") || event.target.closest('button')) {
        document.getElementById("modal").style.display = "none";
      }
    }

    function formatDateTime(date) {
      const pad = (n) => n.toString().padStart(2, '0');
      return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
    }

    init();
  </script>
</body>
</html>
