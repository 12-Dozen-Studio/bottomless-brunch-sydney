<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bottomless Brunch Finder</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    .modal-pill-row {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      margin: 4px 0 2px 0;
    }
    .pill-group {
      display: flex;
      flex-wrap: wrap;
      gap: var(--pill-gap);
    }
    :root {
      /* Color palette */
      --color-bg: #ffffff;
      --color-surface: #f5f1f1;
      --color-border: #d8dfd0;
      --color-accent-1: #556b2f; /* dark olive */
      --color-accent-2: #e7c873; /* gold */
      --color-accent-3: #f7e5d8; /* pale peach */
      --color-accent-4: #cce1b0; /* light olive green */
      --color-text-primary: #1d1f24;
      --color-text-secondary: #666;
      --color-text-caption: #888;
      --color-text-white: #fff;
      --color-icon: #888;
      --color-link: #666;
      --color-link-hover: #1d1f24;
      --color-close: #444;
      --color-pill-bg: #fff;
      --color-pill-border: #888;
      --color-pill-color: #1d1f24;
      --color-pill-inactive-opacity: 0.3;
      --color-pill-bg-accent: var(--color-accent-1);
      --color-pill-border-accent: var(--color-accent-1);
      /* Card/modal */
      --radius-md: 16px;
      --radius-sm: 6px;
      --spacing-xl: 28px;
      --spacing-lg: 20px;
      --spacing-md: 12px;
      --spacing-sm: 8px;
      --spacing-xs: 4px;
      --spacing-xxs: 2px;
      /* Typography */
      --font-title-size: 1.5rem;
      --font-title-weight: 600;
      --font-subtitle-size: 1rem;
      --font-subtitle-weight: 400;
      --font-section-title-size: 1rem;
      --font-section-title-weight: 600;
      --font-stat-value-size: 1.2rem;
      --font-stat-value-weight: bold;
      --font-stat-label-size: 0.875rem;
      --font-body-size: 0.9rem;
      --font-body-weight: 400;
      --font-caption-size: 0.8rem;
      --font-caption-weight: 400;
      /* Pills */
      --pill-radius: 999px; 
      --pill-padding: 2px 10px;
      --pill-font-size: 0.9rem;
      --pill-gap: 3px;
      --pill-height: 20px;
      /* Icon sizes */
      --icon-size: 16px;
      --icon-link-size: 26px;
      --icon-close-size: 28px;
    }
    /* Typography utility classes */
    .text-title {
      font-size: var(--font-title-size);
      font-weight: var(--font-title-weight);
      color: var(--color-text-primary);
      margin: 0;
    }
    .text-subtitle {
      font-size: var(--font-subtitle-size);
      font-weight: var(--font-subtitle-weight);
      color: var(--color-text-secondary);
      margin: 0;
    }
    .text-stat {
      font-size: var(--font-stat-value-size);
      font-weight: var(--font-stat-value-weight);
      color: var(--color-text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .text-body {
      font-size: var(--font-body-size);
      font-weight: var(--font-body-weight);
      color: var(--color-text-primary);
    }
    .text-caption {
      font-size: var(--font-caption-size);
      font-weight: var(--font-caption-weight);
      color: var(--color-text-caption);
    }
    .text-white {
      color: var(--color-text-white) !important;
    }
    .text-center {
      text-align: center;
    }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }
    #map {
      height: 150px;
      width: 100%;
      transition: height 0.3s ease;
    }
    .map-expanded {
      height: 300px !important;
    }
    .filters {
      padding: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: nowrap;
      justify-content: start;
      overflow-x: auto;
      max-width: 100vw;
      -webkit-overflow-scrolling: touch;
    }
    .filter {
      flex: 1;
    }
    .filter select {
      border: none;
      border-radius: var(--pill-radius);
      padding: 6px 18px 6px 10px;
      background-color: var(--color-surface);
      font-size: var(--font-caption-size);
      color: var(--color-text-primary);
      background-image: url('data:image/svg+xml;utf8,<svg fill="black" height="14" viewBox="0 0 24 24" width="14" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 8px center;
      background-size: 14px;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      box-shadow: none;
      cursor: pointer;
      min-width: 100px;
      max-width: 120px;
      text-align: left;
      width: auto;
    }
    .list {
      padding: 10px;
    }
    .card {
      background: var(--color-surface);
      padding: var(--spacing-xs) var(--spacing-md);
      margin-bottom: var(--spacing-md);
      border-radius: var(--radius-md);
      border: 1px solid var(--color-border);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: stretch;
      height: 80px;
    }
    .card-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-width: 0;
      gap: var(--spacing-xs);
    }
    .card-stats-row {
      display: flex;
      gap: var(--spacing-xs);
      margin-top: 2px;
      margin-bottom: 0;
      align-items: center;
      flex-wrap: wrap;
    }

    .stat-pill {
      background: #f2f2f2;
      font-weight: 600;
      border: 1px solid #e0e0e0;
      color: var(--color-text-primary);
      padding: 2px 10px;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      justify-content: flex-end;
      align-items: flex-end;
    }
    .modal-content {
      background: var(--color-bg);
      border-radius: var(--radius-md) var(--radius-md) 0 0;
      width: 100%;
      max-width: 480px;
      padding: 0;
      margin: 0 auto;
      position: relative;
      bottom: 0;
      left: 0;
      right: 0;
      transform: translateY(0);
      transition: transform 0.3s ease-in-out;
      box-sizing: border-box;
    }
    @media (max-width: 375px) {
      .modal-content {
        max-width: 100%;
        border-radius: 16px 16px 0 0;
      }
    }
    .modal-close-area {
      flex-grow: 1;
      height: calc(100% - 400px); /* adjust based on modal content height */
    }
    .modal-map {
      height: 200px;
      margin-top: 10px;
    }
    .timestamp {
      text-align: center;
      font-size: 0.8em;
      color: #666;
      padding: 10px;
    }
    .image-box {
      width: auto;
      height: 100%;
      aspect-ratio: 4 / 3;
      border-radius: 6px;
      background-color: #ddd;
      background-size: cover;
      background-position: center;
      margin-left: 10px;
      flex-shrink: 0;
    }
    .modal-header {
      padding: var(--spacing-lg);
      border-top-left-radius: var(--radius-md);
      border-top-right-radius: var(--radius-md);
      background: var(--color-bg);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--spacing-sm);
    }
    .modal-close-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--color-close);
      font-size: var(--icon-close-size);
      display: flex;
      align-items: center;
      justify-content: center;
      align-self: flex-start;
      padding: 0;
    }
    .modal-stats {
      display: flex;
      justify-content: space-around;
      padding: var(--spacing-md) var(--spacing-lg);
      background: var(--color-bg);
      border-top: 1px solid var(--color-border);
    }
    .modal-stat {
      text-align: center;
      flex: 1;
      min-width: 0;
    }
    .modal-stat .text-stat {
      max-width: 100%;
      display: inline-block;
      line-height: 1.4;
    }
    .modal-stat .cuisine-truncate {
      max-width: 100px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: inline-block;
    }
    .modal-stat .text-caption {
      margin-top: 2px;
      font-size: var(--font-stat-label-size);
      color: var(--color-text-caption);
    }
    .modal-section {
      background: var(--color-bg);
      padding: var(--spacing-md) var(--spacing-lg);
      border-top: 1px solid var(--color-border);
    }
    .modal-section .text-title {
      font-size: var(--font-section-title-size);
      font-weight: var(--font-section-title-weight);
      margin: 0 0 2px 0;
    }
    .modal-links {
      display: flex;
      justify-content: space-around;
      align-items: center;
      text-align: center;
      gap: var(--spacing-sm);
      margin-top: 0;
      margin-bottom: 0;
    }
    .modal-links a {
      color: var(--color-link);
      text-decoration: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      transition: color 0.2s;
    }
    .modal-links a:hover {
      color: var(--color-link-hover);
    }
    .icon {
      width: var(--icon-link-size);
      height: var(--icon-link-size);
      display: inline-block;
      object-fit: contain;
      color: var(--color-icon);
    }
    .material-icons.icon {
      font-size: var(--icon-size) !important;
      color: var(--color-icon);
      line-height: 1;
      vertical-align: middle;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: var(--icon-size);
      height: var(--icon-size);
      padding: 0;
      margin: 0;
      box-sizing: content-box;
    }
    .pill {
      background: var(--color-pill-bg);
      border: 1px solid var(--color-pill-border);
      border-radius: var(--pill-radius);
      padding: var(--pill-padding);
      display: flex;
      align-items: center;
      font-size: var(--pill-font-size);
      gap: var(--pill-gap);
      color: var(--color-pill-color);
      height: var(--pill-height);
      min-width: 0;
      box-sizing: border-box;
    }
    .pill.inactive {
      opacity: var(--color-pill-inactive-opacity);
    }
    .pill-white {
      background: #fff;
      border: 1px solid var(--color-border);
    }
    .card-days-sessions-row {
      display: flex;
      justify-content: start;
      align-items: flex-end;
      margin-top: 2px;
      gap: 7px;
    }
    .card-has-image {
      background:
        linear-gradient(to right, var(--color-surface) 0%, var(--color-surface)50%, rgba(248,248,248,0.0) 90%),
        var(--card-image-url, none) right center / 50% 100% no-repeat,
        var(--color-accent-4);
      background-color: var(--color-surface);
    }
    .card-placeholder-gradient {
      background:
        linear-gradient(
          to right,
          var(--color-surface) 0%,
          var(--color-surface) 50%,
          var(--color-pill-border) 100%
        ),
        var(--color-pill-border);
      background-color: var(--color-surface);
    }
  </style>
</head>
<body>
  <div class="timestamp">
    Page last updated: <span id="lastModified"></span>
  </div>
  <div class="filters">
    <div class="filter">
      <select id="areaFilter">
        <option value="all">Suburb</option>
      </select>
    </div>
    <div class="filter">
      <select id="priceFilter">
        <option value="all">Price</option>
        <option value="low">$0–$89</option>
        <option value="medium">$90–$109</option>
        <option value="high">$110+</option>
      </select>
    </div>
    <div class="filter">
      <select id="cuisineFilter">
        <option value="all">Cuisine</option>
      </select>
    </div>
  </div>

  <div id="map"></div>
  <div class="list" id="venueList"></div>

  <div class="modal" id="modal" onclick="hideModal(event)">
    <div class="modal-close-area"></div>
    <div class="modal-content" id="modalContent">
    </div>
    <div id="modalMap" class="modal-map"></div>
  </div>

  

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let map;
    let markers = [];
    let venues = [];
    let modalMap;

    async function init() {
      const res = await fetch("brunch_venue.json");
      venues = await res.json();

      map = L.map("map").setView([-33.87, 151.21], 12);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

      // Map expand/collapse functionality
      const mapContainer = document.getElementById("map");
      mapContainer.addEventListener("click", () => {
        mapContainer.classList.toggle("map-expanded");
        map.invalidateSize();
      });

      window.addEventListener("scroll", () => {
        if (window.scrollY > 100 && mapContainer.classList.contains("map-expanded")) {
          mapContainer.classList.remove("map-expanded");
          map.invalidateSize();
        }
      });

      populateAreaFilter();
      populateCuisineFilter();
      render();

      document.getElementById("areaFilter").addEventListener("change", render);
      document.getElementById("priceFilter").addEventListener("change", render);
      document.getElementById("cuisineFilter").addEventListener("change", render);

      const lastModified = new Date(document.lastModified);
      document.getElementById("lastModified").textContent = formatDateTime(lastModified);
    }

    function populateAreaFilter() {
      const areaSelect = document.getElementById("areaFilter");
      const areas = [...new Set(venues.map(v => v.suburb))];
      areaSelect.innerHTML = '<option value="all">Suburb</option>' + areas.map(area => `<option value="${area}">${area}</option>`).join('');
    }

    function populateCuisineFilter() {
      const cuisineSelect = document.getElementById("cuisineFilter");
      const cuisines = [...new Set(venues.map(v => v.cuisine).filter(Boolean))];
      cuisineSelect.innerHTML = '<option value="all">Cuisine</option>' + cuisines.map(c => `<option value="${c}">${c}</option>`).join('');
    }

    function render() {
      const day = document.getElementById("dayFilter") ? document.getElementById("dayFilter").value : "all";
      const area = document.getElementById("areaFilter").value;
      const price = document.getElementById("priceFilter").value;
      const cuisine = document.getElementById("cuisineFilter").value;

      const filtered = venues.filter(v => {
        const matchDay = true;
        const matchArea = area === "all" || v.suburb === area;
        const matchCuisine = cuisine === "all" || v.cuisine === cuisine;
        const matchPrice = price === "all" ||
          (price === "low" && v.price < 90) ||
          (price === "medium" && v.price >= 90 && v.price <= 109) ||
          (price === "high" && v.price > 109);
        return matchDay && matchArea && matchCuisine && matchPrice;
      });

      markers.forEach(m => m.remove());
      markers = [];

      const list = document.getElementById("venueList");
      list.innerHTML = "";

      filtered.forEach(v => {
        const div = document.createElement("div");
        div.className = "card";
        div.style.minHeight = "110px";
        if (v.imageUrl && v.imageUrl.trim() !== "") {
          div.classList.add("card-has-image");
          div.style.setProperty('--card-image-url', `url('${v.imageUrl}')`);
        } else {
          div.classList.add("card-placeholder-gradient");
        }

        // Price pill background logic:
        // < 90: default .pill, no inline background
        // 90–109: background var(--color-accent-4)
        // > 109: background var(--color-accent-3)
        let pricePill;
        if (v.price < 90) {
          pricePill = `<div class="pill text-caption">$${v.price}</div>`;
        } else if (v.price >= 90 && v.price <= 109) {
          pricePill = `<div class="pill text-caption" style="background: var(--color-accent-4);">$${v.price}</div>`;
        } else if (v.price > 109) {
          pricePill = `<div class="pill text-caption" style="background: var(--color-accent-3);">$${v.price}</div>`;
        }

        // Pills for duration and cuisine (use text-caption class, no stat-pill or pill-white)
        const durationPill = `<div class="pill text-caption"><span class="material-icons icon">schedule</span>${v.duration} min</div>`;
        const cuisinePill = `<div class="pill text-caption">${v.cuisine || ""}</div>`;

        // Days/sessions row: use .card-days-sessions-row, no inline styles
        const daysRow = `
          <div class="card-days-sessions-row">
            <div class="text-caption card-days-row">${v.days?.join(", ") || ""}</div>
            <div class="text-caption card-sessions-row">${v.sessions?.join(", ") || ""}</div>
          </div>
        `;

        // Render card with required markup, no static inline overrides
        div.innerHTML = `
          <div class="card-info">
            <h3 class="text-title">${v.name}</h3>
            <div class="text-caption"><span class="material-icons icon">location_on</span> ${v.suburb}</div>
            <div class="card-stats-row">
              ${pricePill}
              ${durationPill}
              ${cuisinePill}
            </div>
            ${daysRow}
          </div>
        `;
        div.onclick = () => showModal(v);
        list.appendChild(div);

        const lat = v.lat !== undefined ? v.lat : (-33.87 + Math.random() * 0.05);
        const lng = v.lng !== undefined ? v.lng : (151.21 + Math.random() * 0.05);
        const marker = L.marker([lat, lng]).addTo(map)
          .on('click', () => showModal(v));
        markers.push(marker);
      });
    }

    function showModal(v) {
      const modal = document.getElementById("modal");
      const content = document.getElementById("modalContent");

      // Prepare days and sessions
      const days = Array.isArray(v.days) ? v.days : [];
      const sessions = Array.isArray(v.sessions) ? v.sessions : [];

      // Compose pills for days
      const dayPills = days.map(day =>
        `<div class="pill text-caption">${day}</div>`
      ).join('');
      // Compose pills for sessions (first session pill as accent demo)
      const sessionPills = sessions.map((session, i) =>
        i === 0
          ? `<div class="pill text-caption text-white" style="background: var(--color-accent-1); border-color: var(--color-accent-1);">${session}</div>`
          : `<div class="pill text-caption">${session}</div>`
      ).join('');

      content.innerHTML = `
  <div class="modal-header">
    <div>
      <h2 class="text-title">${v.name}</h2>
      <p class="text-subtitle">${v.suburb}</p>
      <div class="modal-pill-row">
        <span class="material-icons icon">calendar_today</span>
        <div class="pill-group">${dayPills}</div>
      </div>
      <div class="modal-pill-row">
        <span class="material-icons icon">schedule</span>
        <div class="pill-group">${sessionPills}</div>
      </div>
    </div>
    <button class="modal-close-btn" onclick="hideModal(event)">
      <span class="material-icons icon" style="font-size: var(--modal-close-size); color: var(--modal-close-color);">close</span>
    </button>
  </div>
  <div class="modal-stats">
    <div class="modal-stat">
      <div class="text-stat">$${v.price}</div>
      <div class="text-caption">per person</div>
    </div>
    <div class="modal-stat">
      <div class="text-stat">${v.duration}min</div>
      <div class="text-caption">session</div>
    </div>
    <div class="modal-stat">
      <div class="text-stat cuisine-truncate" title="${v.cuisine || ''}">${v.cuisine || ''}</div>
      <div class="text-caption">cuisine</div>
    </div>
  </div>
  <div class="modal-section">
    <h3 class="text-title">Details</h3>
    <p class="text-body">${v.description || ''}</p>
  </div>
  <div class="modal-section">
    <h3 class="text-title">Address</h3>
    <p class="text-body">${v.address || ''}</p>
  </div>
  <div class="modal-section">
    <div class="modal-links">
      ${v.website ? `<a href="${v.website}" target="_blank">
        <img src="https://img.icons8.com/ios-filled/50/666666/domain.png" alt="Website" class="icon" />
        <span class="text-body text-center">Website</span>
      </a>` : ''}
      ${v.instagram ? `<a href="${v.instagram}" target="_blank">
        <img src="https://img.icons8.com/ios-filled/50/666666/instagram-new.png" alt="Instagram" class="icon" />
        <span class="text-body text-center">Instagram</span>
      </a>` : ''}
      ${v.name ? `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(v.name + ', ' + (v.suburb || ''))}" target="_blank">
        <img src="https://img.icons8.com/ios-filled/50/666666/marker.png" alt="Google Maps" class="icon" />
        <span class="text-body text-center">Maps</span>
      </a>` : ''}
    </div>
  </div>
`;

      if (modalMap) {
        modalMap.remove();
      }
      const lat = v.lat !== undefined ? v.lat : (-33.87 + Math.random() * 0.05);
      const lng = v.lng !== undefined ? v.lng : (151.21 + Math.random() * 0.05);
      modalMap = L.map("modalMap").setView([lat, lng], 14);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(modalMap);
      L.marker([lat, lng]).addTo(modalMap);

      modal.style.display = "flex";
    }

    function hideModal(event) {
      if (!event || event.target.classList.contains("modal") || event.target.classList.contains("modal-close-area") || event.target.closest('button')) {
        document.getElementById("modal").style.display = "none";
      }
    }

    function formatDateTime(date) {
      const pad = (n) => n.toString().padStart(2, '0');
      return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
    }

    init();
  </script>
</body>
</html>
